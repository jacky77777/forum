<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="icon" href="../../dev/image/title/logoimage.ico" type="image/x-icon">
    <link rel="shortcut icon" type="image/x-icon" href="../../dev/image/title/logoimage.ico" />
    <!-- <link rel="stylesheet" type="text/css" th:href="@{../index/style.css}">
    <link rel="stylesheet" type="text/css" href="/dest/index/style.css">
    <link rel="stylesheet" type="text/css" href="/dest/index/style.css"> -->
    <link rel="stylesheet" href="/dest/index/style.css">
    <link rel="stylesheet" href="/dest/index/earth/css/earth.css">
    <script src="/node_modules/jquery/dist/jquery.js"></script>
    <script src="/dest/index/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js"></script>
    <script src="https://d3js.org/d3-geo.v1.js"></script>
    <script src="https://d3js.org/topojson.v2.js"></script>
    <script src="https://bl.ocks.org/mbostock/raw/7ea1dde508cec6d2d95306f92642bc42/6aac691494f752142a67cc43c51a0fd09896dbd4/versor.js"></script>
</head>

<body>
    <header>
        <div class="nothing"></div>
        <ul class="list-title">
            <li><a href="/dest/Entertaining/Entertaining.html">防疫知識王</a></li>
            <li><a href="/dest/forum/forum.html">討論區</a></li>
            <li><a href="/dest/Infectious-Diseases/Infectious-Diseases.html">傳染病事記</a></li>
            <li class="logo"><a href="/dest/index/index.html"></a></li>
            <li><a href="/dest/latest-news/latest-news.html">最新消息</a></li>
            <li><a href="/dest/Epidemic-prevention-SOP/Epidemic-prevention-SOP.html">防疫SOP</a></li>
            <li><a href="/dest/Epidemic-shop/Epidemic-shop.html">防疫商店</a></li>
        </ul>
        <div class="fuction">
            <div class="up" id="login-btn">login</div>
            <div class="down">down</div>
        </div>
        <div class="login-Bg" id="loginBg">
            <div class="login-Box">
                <div class="sign-title">
                    <h1 id="sign-in">登入</h1>
                    <h1 id="sign-up">註冊</h1>
                </div>
                <div class="X" id="btnX">
                    <span class="left"></span>
                    <span class="right"></span>
                </div>
                <form class="sign sign-in" action="/dest/index/sign-in.php" method="GET">

                    <label for="emeEmail">登入信箱<br>
                        <input class="input-data" type="email" name="emeEmail">
                    </label><br>

                    <label for="emePaw">登入密碼<br>
                        <input class="input-data" type="password" name="emePaw"><br>
                        <input class="viveswitch" type="checkbox">顯示密碼
                    </label>
                    <a href="">忘記密碼</a>
                    <br>
                    <input class="submit" type="submit" name="login" value="登入">
                </form>

                <form class="sign sign-up" action="/dest/index/sign-up.php" method="GET">
                    <label for="upEmail">註冊信箱<br>
                        <input class="input-data" type="email" name="upEmail">
                    </label><br>

                    <label for="upPaw">註冊密碼<br>
                        <input class="input-data" type="password" name="upPaw"><br>
                        <input class="viveswitch" type="checkbox" id="vivePsw">顯示密碼
                    </label>
                    <a href="">忘記密碼</a>
                    <br>
                    <input class="submit" type="submit" name="login" value="登入">
                </form>
            </div>
        </div>
    </header>

    <section class="hanEarth">
        <div class="stars">
            <ul class="Showtable">
                <li id="curentCitys"></li>
                <li id="curentConfirmed"></li>
                <li id="curentDeath"></li>
                <li id="curentRecovered"></li>
            </ul>
            <h2 id="current"></h2>
            <div class="clouds"><canvas id="globe"></canvas>
            </div>
        </div>
    </section>

    <section class="leon">

    </section>



    <footer>
        <div class="footer">
            <ul class="list-left">
                <li>防疫大富翁
                    <a href="">規則說明</a>
                </li>
                <li>討論區
                    <a href="">新增文章</a>
                    <a href="">熱搜排行</a>
                </li>
                <li>傳染病介紹
                    <a href="">法定傳染病</a>
                    <a href="">依照傳染途徑</a>
                </li>
                <li>最新消息
                    <a href="">國內疫情確診分佈</a>
                    <a href="">國際醫療時事</a>
                    <a href="">國內醫療時事</a>
                    <a href="">醫療政令</a>
                    <a href="">醫療新聞</a>
                </li>
                <li>防疫商店
                    <a href="">虛擬展示功能</a>
                    <a href="">熱門商品</a>
                    <a href="">購物車</a>
                </li>
                <li>會員中心
                    <a href="">會員註冊</a>
                    <a href="">訂單查詢</a>
                    <a href="">忘記密碼</a>
                    <a href="">點數查詢</a>
                </li>
                <li>防疫SOP
                    <a href="">肺炎自我評估</a>
                </li>
            </ul>
            <ul class="list-right">
                <li>關注我們</li>
                <li>
                    <ul class="icon">
                        <li><a class="ig" href="">ig</a></li>
                        <li><a class="fb" href="">fb</a></li>
                        <li><a class="tw" href="">tw</a></li>
                        <li><a class="pin" href="">pin</a></li>
                        <li><a class="yt" href="">yt</a></li>
                    </ul>
                </li>
                <li>訂閱我們</li>
                <form action="">
                    <input class="email" type="text" placeholder="E-mail">
                    <input class="email-on" type="submit" value="訂閱">
                </form>
            </ul>
        </div>
    </footer>
    <script>
        window.addEventListener('load', function () {
            var rotationDelay = 500
            var scaleFactor = 0.6
            var degPerSec = 6
            var angles = {
                x: -20,
                y: 40,
                z: 0
            }
            var colorWater = '#54a0ff'
            var colorLand = '#B99362' //島嶼F19BFE
            var colorGraticule = '#181236' //181236
            var colorCountry = '#10ac84' //F6C1BC
            var newdataList = [];
            var dataList;
            var selectsItem;

            function enter(country) {
                var country = countryList.find(function (c) {
                    return c.id === country.id;
                })

                let datenum, confirmed, death, recovered;
                let citys = Object.keys(dataList).find((city) => {
                    // console.log(city, country.name.trim());
                    if (country != undefined && country.name === city) {
                        // console.log(city);
                        return city;
                    }
                });

                if (citys) {
                    datenum = dataList[citys].length - 1
                    confirmed = dataList[citys][datenum].confirmed
                    death = dataList[citys][datenum].deaths;
                    recovered = dataList[citys][datenum].recovered;
                    Showtable._groups[0][0].style.right = 0;
                    Showtable._groups[0][0].style.background = '#ccc';
                    Showtable._groups[0][0].style.transition = 'all 1s';
                    //將顏色框共同改變
                    [curentCitys, curentConfirmed, curentDeath, curentRecovered].forEach(item => {
                        item._groups[0][0].style.border = '1px solid red';
                    });
                    //顯示地圖資料
                    curentCitys.text(country &&
                        `地區:${citys} `)
                    curentConfirmed.text(country &&
                        `確診人數: ${confirmed} `)
                    curentDeath.text(country &&
                        `死亡人數: ${death}`)
                    curentRecovered.text(country &&
                        `已完成隔離人數: ${recovered}`)
                }
            }

            function leave(country) {
                Showtable._groups[0][0].style.right = '-100%';
                Showtable._groups[0][0].style.background = 'none';
                Showtable._groups[0][0].style.transition = 'all 1s';
                [curentCitys, curentConfirmed, curentDeath, curentRecovered].forEach(item => {
                    item.text('');
                    item._groups[0][0].style.border = 'none';
                });
            }

            //
            // Variables
            //
            var Showtable = d3.select('.Showtable')
            var curentCitys = d3.select('#curentCitys')
            var curentConfirmed = d3.select('#curentConfirmed')
            var curentDeath = d3.select('#curentDeath')
            var curentRecovered = d3.select('#curentRecovered')
            // var current = d3.select('#current')
            var canvas = d3.select('#globe')
            var context = canvas.node().getContext('2d')
            var water = {
                type: 'Sphere'
            }
            var projection = d3.geoOrthographic().precision(0.1)
            var graticule = d3.geoGraticule10()
            var path = d3.geoPath(projection).context(context)
            var v0 // Mouse position in Cartesian coordinates at start of drag gesture.
            var r0 // Projection rotation as Euler angles at start.
            var q0 // Projection rotation as versor at start.
            var lastTime = d3.now()
            var degPerMs = degPerSec / 1000
            var width, height
            var land, countries
            var countryList
            var autorotate, now, diff, roation
            var currentCountry


            //
            // Functions
            //

            function setAngles() {
                var rotation = projection.rotate()
                rotation[0] = angles.y
                rotation[1] = angles.x
                rotation[2] = angles.z
                projection.rotate(rotation)
            }

            function scale() {
                width = document.documentElement.clientWidth
                height = document.documentElement.clientHeight
                canvas.attr('width', width).attr('height', height)
                projection
                    .scale((scaleFactor * Math.min(width, height)) / 2)
                    .translate([width / 2, height / 2])
                render()
            }

            function startRotation(delay) {
                autorotate.restart(rotate, delay || 0)
            }

            function stopRotation() {
                autorotate.stop()
            }

            function dragstarted() {
                v0 = versor.cartesian(projection.invert(d3.mouse(this)))
                r0 = projection.rotate()
                q0 = versor(r0)
                stopRotation()
            }

            function dragged() {
                var v1 = versor.cartesian(projection.rotate(r0).invert(d3.mouse(this)))
                var q1 = versor.multiply(q0, versor.delta(v0, v1))
                var r1 = versor.rotation(q1)
                projection.rotate(r1)
                render()
            }

            function dragended() {
                startRotation(rotationDelay)
            }

            function render() {
                context.clearRect(0, 0, width, height)
                fill(water, colorWater)
                stroke(graticule, colorGraticule)
                fill(land, colorLand)
                // strokeRect(currentCountry,'#000')
                if (currentCountry) {
                    fill(currentCountry, colorCountry)

                }
            }

            function fill(obj, color) {
                context.beginPath()
                path(obj)
                context.fillStyle = color
                context.fill()
            }

            function stroke(obj, color) {
                context.beginPath()
                path(obj)
                context.strokeStyle = color
                context.stroke()
            }

            function rotate(elapsed) {
                now = d3.now()
                diff = now - lastTime
                if (diff < elapsed) {
                    rotation = projection.rotate()
                    rotation[0] += diff * degPerMs
                    projection.rotate(rotation)
                    render()
                }
                lastTime = now
            }
            function loadData(cb) {
                
                d3.json('/dest/index/earth/json/worldMap.json', function (error, world) {
                    if (error) throw error
                    d3.tsv('/dest/index/earth/json/earth.tsv', function (error, countries) {
                        if (error) throw error;
                        d3.json('https://pomber.github.io/covid19/timeseries.json', function (error, data) {
                            if (error) throw error;
                            cb(world, countries, data)
                        });

                    })
                })
            }

            // https://github.com/d3/d3-polygon
            function polygonContains(polygon, point) {
                var n = polygon.length
                var p = polygon[n - 1]
                var x = point[0],
                    y = point[1]
                var x0 = p[0],
                    y0 = p[1]
                var x1, y1
                var inside = false
                for (var i = 0; i < n; ++i) {
                    p = polygon[i], x1 = p[0], y1 = p[1]
                    if (((y1 > y) !== (y0 > y)) && (x < (x0 - x1) * (y - y1) / (y0 - y1) + x1)) inside = !inside
                    x0 = x1, y0 = y1
                }
                return inside
            }

            function mousemove() {
                var c = getCountry(this)
                if (!c) {
                    if (currentCountry) {
                        leave(currentCountry)
                        currentCountry = undefined
                        render()
                    }
                    return
                }
                if (c === currentCountry) {
                    return
                }
                currentCountry = c
                // console.log(currentCountry);
                render()
                enter(c)

            }

            function getCountry(event) {
                var pos = projection.invert(d3.mouse(event))

                return countries.features.find(function (f) {
                    return f.geometry.coordinates.find(function (c1) {
                        return polygonContains(c1, pos) || c1.find(function (c2) {
                            return polygonContains(c2, pos)
                        })
                    })
                })
            }

            //
            // Initialization
            //

            setAngles()

            canvas
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended)
                )
                .on('mousemove', mousemove)

            loadData(function (world, cList, data) {
                land = topojson.feature(world, world.objects.land)
                countries = topojson.feature(world, world.objects.countries)
                countryList = cList
                dataList = data

                window.addEventListener('resize', scale)
                scale()
                autorotate = d3.timer(rotate)
            });

        })
    </script>
    <img src="/dest/index/earth/json/worldMap.json" alt="">
</body>

</html>